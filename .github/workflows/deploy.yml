name: Deploy to Azure VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Pipeline to Azure
    runs-on: ubuntu-latest

    env:
      AZURE_HOST: ${{ secrets.AZURE_HOST }}
      AZURE_USER: ${{ secrets.AZURE_USER }}
      PROJECT_PATH: ${{ secrets.PROJECT_PATH }}

    steps:
      - name: Write SSH private key
        run: |
          cat > key.pem <<'EOF'
${{ secrets.AZURE_SSH_KEY }}
EOF
          chmod 600 key.pem

      - name: Add VM to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$AZURE_HOST" >> ~/.ssh/known_hosts

      - name: Debug connection info (no secrets)
        run: |
          echo "Will try to connect to $AZURE_USER@$AZURE_HOST"
          echo "Project path on VM: $PROJECT_PATH"

      - name: SSH deploy (git pull + docker compose up)
        run: |
          ssh -i key.pem \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            "$AZURE_USER@$AZURE_HOST" "
              set -e
              cd \"$PROJECT_PATH\"
              git pull
              docker compose up -d --build
              docker compose ps
            "
