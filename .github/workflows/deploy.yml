name: Deploy to Azure VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Pipeline to Azure
    runs-on: ubuntu-latest

    env:
      AZURE_HOST: ${{ secrets.AZURE_HOST }}
      AZURE_USER: ${{ secrets.AZURE_USER }}
      PROJECT_PATH: ${{ secrets.PROJECT_PATH }}

    steps:
      - name: Write SSH private key
        run: |
          set -e
          cat > key.pem <<'EOF'
          ${{ secrets.AZURE_SSH_KEY }}
          EOF
          # prevent CRLF issues
          sed -i 's/\r$//' key.pem
          chmod 600 key.pem

      - name: Add VM to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$AZURE_HOST" >> ~/.ssh/known_hosts

      - name: Debug connection info (no secrets)
        run: |
          echo "Will try to connect to $AZURE_USER@$AZURE_HOST"
          echo "Project path on VM: $PROJECT_PATH"

      - name: SSH deploy (git pull + docker compose up)
        run: |
          ssh -i key.pem "$AZURE_USER@$AZURE_HOST" "
            set -e
            cd \"$PROJECT_PATH\"
            git pull
            docker compose up -d --build
            docker compose ps
          "

      - name: Smoke test â€“ HTTP health checks
        run: |
          ssh -i key.pem "$AZURE_USER@$AZURE_HOST" '
            set -e

            echo "ğŸ” Checking Streamlit..."
            curl -fsS http://localhost:8501 >/dev/null
            echo "âœ… Streamlit OK"

            echo "ğŸ” Checking MinIO readiness..."
            curl -fsS http://localhost:9000/minio/health/ready >/dev/null
            echo "âœ… MinIO OK"

            echo "ğŸ” Checking Cleaner metrics..."
            curl -fsS http://localhost:8003/metrics | head -n 5
            echo "âœ… Cleaner metrics OK"

            echo "âœ… All smoke tests passed."
          '
